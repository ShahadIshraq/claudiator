#!/bin/bash
set -e

REPO_ROOT=$(git rev-parse --show-toplevel)

STAGED_SWIFT=$(git diff --cached --name-only -z --diff-filter=ACM | tr '\0' '\n' | grep '\.swift$' || true)
STAGED_RS=$(git diff --cached --name-only -z --diff-filter=ACM | tr '\0' '\n' | grep '\.rs$' || true)

# --- Swift checks ---

if [ -n "$STAGED_SWIFT" ]; then
  echo "Running SwiftFormat on staged files..."
  printf '%s\0' $STAGED_SWIFT | xargs -0 swiftformat --config ios/.swiftformat
  printf '%s\0' $STAGED_SWIFT | xargs -0 git add

  echo "Running SwiftFormat lint on ios/..."
  (cd "$REPO_ROOT" && swiftformat --lint --config ios/.swiftformat ios/Claudiator/)

  echo "Running SwiftLint on staged files..."
  printf '%s\0' $STAGED_SWIFT | xargs -0 swiftlint lint --strict --config ios/.swiftlint.yml --quiet
fi

# --- Rust checks ---

if [ -n "$STAGED_RS" ]; then
  HOOK_RS=$(echo "$STAGED_RS" | grep '^hook/' || true)
  SERVER_RS=$(echo "$STAGED_RS" | grep '^server/' || true)

  if [ -n "$HOOK_RS" ]; then
    echo "Running cargo fmt on hook/..."
    (cd "$REPO_ROOT/hook" && cargo fmt)
    echo "$HOOK_RS" | tr '\n' '\0' | xargs -0 -I{} git add "$REPO_ROOT/{}"
    echo "Running cargo clippy on hook/..."
    (cd "$REPO_ROOT/hook" && cargo clippy --all-targets -- -D warnings)
  fi

  if [ -n "$SERVER_RS" ]; then
    echo "Running cargo fmt on server/..."
    (cd "$REPO_ROOT/server" && cargo fmt)
    echo "$SERVER_RS" | tr '\n' '\0' | xargs -0 -I{} git add "$REPO_ROOT/{}"
    echo "Running cargo clippy on server/..."
    (cd "$REPO_ROOT/server" && cargo clippy -- \
        -D warnings \
        -A missing_docs \
        -A clippy::missing_errors_doc \
        -A clippy::redundant_pub_crate \
        -A unreachable_pub)
  fi
fi
